{
  "id": "IMPL-005",
  "title": "修复 Stats API 数据源并统一健康状态",
  "status": "completed",
  "context_package_path": ".workflow/active/WFS-fix-config-data-inconsistency/context-package.json",
  "cli_execution_id": "WFS-fix-config-data-inconsistency-IMPL-005",
  "cli_execution": {
    "strategy": "new",
    "resume_from": "WFS-fix-config-data-inconsistency-IMPL-004"
  },
  "meta": {
    "type": "bugfix",
    "agent": "@code-developer",
    "execution_group": null,
    "module": null,
    "execution_config": {
      "method": "agent",
      "cli_tool": "auto",
      "enable_resume": true,
      "previous_cli_id": null
    }
  },
  "context": {
    "requirements": [
      "修改 2 个文件: [src/presentation/api/v1/stats.route.ts, src/presentation/api/admin.route.ts]",
      "替换硬编码模拟数据为真实健康检查结果",
      "统一 3 个端点的健康状态: [/api/stats, /admin/api/stats, /api/health]",
      "确保数据实时性和一致性"
    ],
    "focus_paths": [
      "src/presentation/api/v1/stats.route.ts",
      "src/presentation/api/admin.route.ts",
      "src/application/use-cases/health-check.use-case.ts"
    ],
    "acceptance": [
      "2 个路由已修改: stats.route.ts 和 admin.route.ts",
      "3 个端点数据一致: 验证 jq '.sources.healthy' 在所有端点返回相同值",
      "实时数据: 验证数据来自 HealthCheckUseCase 而非硬编码",
      "缓存控制: Cache-Control 头设置为 300 秒"
    ],
    "depends_on": ["IMPL-004"],
    "inherited": {
      "from": "IMPL-004",
      "context": [
        "Health Check 验证逻辑已优化",
        "有合理的源被标记为 healthy/degraded",
        "Stats API 仍使用模拟数据，需要修复"
      ]
    },
    "shared_context": {
      "tech_stack": ["Deno", "Oak", "TypeScript"],
      "current_issue": "Stats API 使用 Math.random() 模拟数据",
      "solution": "使用 HealthCheckUseCase.checkAllSources() 获取真实数据",
      "cache_strategy": "5 分钟缓存 (300 秒) 减少实时检查开销"
    },
    "artifacts": []
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_context_package",
        "action": "加载会话上下文和前置任务结果",
        "commands": [
          "Read(.workflow/active/WFS-fix-config-data-inconsistency/workflow-session.json)",
          "Read(.workflow/active/WFS-fix-config-data-inconsistency/.task/IMPL-004.json)"
        ],
        "output_to": "session_context",
        "on_error": "fail"
      },
      {
        "step": "analyze_stats_routes",
        "action": "分析所有 Stats 端点的当前实现",
        "commands": [
          "Read(src/presentation/api/v1/stats.route.ts)",
          "Read(src/presentation/api/admin.route.ts 第 18-39 行)",
          "bash(curl -s http://localhost:8000/api/stats | jq '.sources')"
        ],
        "output_to": "stats_routes_analysis",
        "on_error": "fail"
      }
    ],
    "implementation_approach": [
      {
        "step": 1,
        "title": "分析 Stats 端点的数据源",
        "description": "确认 /api/stats 和 /admin/api/stats 端点的当前数据来源",
        "modification_points": [
          "分析 2 个路由文件: stats.route.ts 和 admin.route.ts",
          "确认模拟数据的位置 (Math.random() 调用)",
          "理解当前返回的数据结构"
        ],
        "logic_flow": [
          "读取 stats.route.ts 第 18-24 行 (stats 实现)",
          "读取 admin.route.ts 第 18-39 行 (admin stats 实现)",
          "确认两个端点都使用模拟数据",
          "理解需要替换的代码段"
        ],
        "depends_on": [],
        "output": "stats_data_source_analyzed"
      },
      {
        "step": 2,
        "title": "修改 /api/stats 使用真实健康检查数据",
        "description": "在 stats.route.ts 中替换模拟数据为 HealthCheckUseCase 结果",
        "modification_points": [
          "修改 1 个文件: src/presentation/api/v1/stats.route.ts",
          "注入 HealthCheckUseCase 依赖",
          "替换 Math.random() 为 useCase.checkAllSources()",
          "映射 health report 到 stats 响应格式"
        ],
        "logic_flow": [
          "修改 createStatsRoute 函数签名，接受 HealthCheckUseCase 参数",
          "在 GET /api/stats 处理器中:\n  - 调用 useCase.checkAllSources()\n  - 提取 total, healthy, degraded, failed\n  - 构建响应对象，替换所有 Math.random() 调用",
          "添加缓存控制 (Cache-Control: max-age=300)",
          "更新 main.ts 中的路由创建代码，传入 HealthCheckUseCase"
        ],
        "depends_on": [1],
        "output": "api_stats_fixed"
      },
      {
        "step": 3,
        "title": "修改 /admin/api/stats 使用真实数据",
        "description": "在 admin.route.ts 中替换模拟数据为真实健康检查结果",
        "modification_points": [
          "修改 1 个文件: src/presentation/api/admin.route.ts",
          "注入 HealthCheckUseCase 依赖",
          "替换 GET /api/stats 端点的模拟数据",
          "确保与 /api/v1/stats 返回一致数据"
        ],
        "logic_flow": [
          "修改 createAdminRoute 函数签名，接受 HealthCheckUseCase 参数",
          "在 GET /api/stats 处理器中:\n  - 调用 useCase.checkAllSources()\n  - 替换 sources.healthy, sources.degraded, sources.failed 等字段",
          - 移除所有 Math.random() 调用",
          "更新 main.ts 中的 adminRouter 创建代码，传入 HealthCheckUseCase"
        ],
        "depends_on": [2],
        "output": "admin_stats_fixed"
      },
      {
        "step": 4,
        "title": "更新 main.ts 中的路由依赖注入",
        "description": "在 main.ts 中为 stats 和 admin 路由注入 HealthCheckUseCase",
        "modification_points": [
          "修改 1 个文件: src/main.ts",
          "创建 HealthCheckUseCase 实例",
          "更新 createStatsRoute() 和 createAdminRoute() 调用",
          "确保依赖正确传递"
        ],
        "logic_flow": [
          "在 main.ts 中创建 healthCheckUseCase 实例",
          "修改 createStatsRoute(healthCheckUseCase)",
          "修改 createAdminRoute(healthCheckUseCase)",
          "验证代码编译无错误"
        ],
        "depends_on": [3],
        "output": "main_ts_updated"
      },
      {
        "step": 5,
        "title": "验证 Stats API 数据一致性",
        "description": "测试所有 Stats 端点返回与 Health API 一致的数据",
        "modification_points": [
          "测试 3 个端点: [/api/health, /api/stats, /admin/api/stats]",
          "对比 healthy/degraded/failed 计数",
          "验证数据实时性 (缓存生效)"
        ],
        "logic_flow": [
          "调用 3 个 API 并提取统计:\n  - HEALTH=$(curl -s http://localhost:8000/api/health | jq '{healthy, degraded, failed}')\n  - STATS=$(curl -s http://localhost:8000/api/stats | jq '.sources')\n  - ADMIN_STATS=$(curl -s http://localhost:8000/admin/api/stats | jq '.sources')",
          "对比 3 个变量的 healthy, degraded, failed 值",
          "验证它们完全相等",
          "检查 Cache-Control 响应头设置正确"
        ],
        "depends_on": [4],
        "output": "stats_consistency_verified"
      }
    ],
    "target_files": [
      "src/presentation/api/v1/stats.route.ts",
      "src/presentation/api/admin.route.ts",
      "src/main.ts"
    ]
  }
}
